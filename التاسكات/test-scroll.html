<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار السكرول - نظام إدارة المشاريع</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            padding: 2rem;
            background: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 2rem;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            color: #3498db;
            margin-bottom: 1rem;
        }
        .status {
            padding: 0.5rem;
            border-radius: 3px;
            margin: 0.5rem 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 1rem;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .btn.danger:hover {
            background: #c0392b;
        }
        .btn.success {
            background: #27ae60;
        }
        .btn.success:hover {
            background: #229954;
        }
        .scroll-test {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 1rem;
            margin: 1rem 0;
        }
        .scroll-content {
            height: 1000px;
            background: linear-gradient(to bottom, #3498db, #e74c3c);
            color: white;
            padding: 1rem;
            text-align: center;
        }
        .chart-test {
            width: 100%;
            height: 200px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 اختبار إصلاحات السكرول</h1>
        
        <div class="test-section">
            <h3>📊 حالة النظام</h3>
            <div id="systemStatus"></div>
            <button class="btn" onclick="checkSystemStatus()">فحص النظام</button>
        </div>
        
        <div class="test-section">
            <h3>🔄 اختبار السكرول</h3>
            <div class="scroll-test" id="scrollTest">
                <div class="scroll-content">
                    <h4>منطقة اختبار السكرول</h4>
                    <p>قم بالسكرول هنا لاختبار السلوك الطبيعي</p>
                    <div style="margin-top: 200px;">
                        <p>إذا كان السكرول يعمل بشكل طبيعي، فالإصلاح نجح</p>
                    </div>
                    <div style="margin-top: 200px;">
                        <p>إذا كان هناك سكرول تلقائي، فهناك مشكلة</p>
                    </div>
                    <div style="margin-top: 200px;">
                        <p>نهاية منطقة الاختبار</p>
                    </div>
                </div>
            </div>
            <div id="scrollStatus"></div>
            <button class="btn" onclick="testScroll()">اختبار السكرول</button>
            <button class="btn danger" onclick="resetScroll()">إعادة تعيين</button>
        </div>
        
        <div class="test-section">
            <h3>📈 اختبار الرسوم البيانية</h3>
            <div class="chart-test" id="chartTest">
                <div class="loading">⏳ جاري التحميل...</div>
            </div>
            <div id="chartStatus"></div>
            <button class="btn" onclick="testChart()">اختبار الرسم البياني</button>
            <button class="btn danger" onclick="stopAllIntervals()">إيقاف التحديثات</button>
        </div>
        
        <div class="test-section">
            <h3>🛠️ أدوات التشخيص</h3>
            <button class="btn" onclick="showDiagnostics()">عرض التشخيص</button>
            <button class="btn success" onclick="window.open('index.html', '_blank')">فتح النظام</button>
            <button class="btn danger" onclick="clearAllData()">مسح البيانات</button>
        </div>
        
        <div class="test-section">
            <h3>📋 سجل الأحداث</h3>
            <div id="eventLog" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border: 1px solid #dee2e6;"></div>
            <button class="btn" onclick="clearLog()">مسح السجل</button>
        </div>
    </div>

    <script>
        let scrollEvents = 0;
        let chartUpdateCount = 0;
        let eventLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            eventLog.push(`[${timestamp}] ${message}`);
            
            const logElement = document.getElementById('eventLog');
            const statusClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            logElement.innerHTML = eventLog.map(entry => `<div class="status ${statusClass}">${entry}</div>`).join('');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            let html = '';
            
            // فحص LocalStorage
            const hasLocalStorage = typeof(Storage) !== "undefined";
            html += `<div class="status ${hasLocalStorage ? 'success' : 'error'}">
                LocalStorage: ${hasLocalStorage ? '✅ مدعوم' : '❌ غير مدعوم'}
            </div>`;
            
            // فحص Chart.js
            const hasChart = typeof Chart !== 'undefined';
            html += `<div class="status ${hasChart ? 'success' : 'error'}">
                Chart.js: ${hasChart ? '✅ محمل' : '❌ غير محمل'}
            </div>`;
            
            // فحص Service Worker
            const hasServiceWorker = 'serviceWorker' in navigator;
            html += `<div class="status ${hasServiceWorker ? 'success' : 'warning'}">
                Service Worker: ${hasServiceWorker ? '✅ مدعوم' : '⚠️ غير مدعوم'}
            </div>`;
            
            // فحص الدوال المخصصة
            const hasScrollFix = typeof stopAllIntervals === 'function';
            html += `<div class="status ${hasScrollFix ? 'success' : 'error'}">
                إصلاحات السكرول: ${hasScrollFix ? '✅ محملة' : '❌ غير محملة'}
            </div>`;
            
            statusDiv.innerHTML = html;
            log('تم فحص حالة النظام', hasLocalStorage && hasChart ? 'info' : 'warning');
        }
        
        function testScroll() {
            const scrollTest = document.getElementById('scrollTest');
            const statusDiv = document.getElementById('scrollStatus');
            
            scrollEvents = 0;
            let testDuration = 5000; // 5 ثوان
            let startTime = Date.now();
            
            // مراقبة أحداث السكرول
            const scrollHandler = () => {
                scrollEvents++;
            };
            
            scrollTest.addEventListener('scroll', scrollHandler);
            
            // اختبار السكرول التلقائي
            let autoScrollInterval = setInterval(() => {
                scrollTest.scrollTop += 10;
            }, 100);
            
            setTimeout(() => {
                clearInterval(autoScrollInterval);
                scrollTest.removeEventListener('scroll', scrollHandler);
                
                let status = '';
                if (scrollEvents > 100) {
                    status = `<div class="status error">❌ سكرول مفرط: ${scrollEvents} حدث</div>`;
                    log(`اختبار السكرول فشل: ${scrollEvents} حدث`, 'error');
                } else if (scrollEvents > 50) {
                    status = `<div class="status warning">⚠️ سكرول كثير: ${scrollEvents} حدث</div>`;
                    log(`اختبار السكرول: تحذير ${scrollEvents} حدث`, 'warning');
                } else {
                    status = `<div class="status success">✅ سكرول طبيعي: ${scrollEvents} حدث</div>`;
                    log(`اختبار السكرول نجح: ${scrollEvents} حدث`, 'info');
                }
                
                statusDiv.innerHTML = status;
            }, testDuration);
            
            log('بدء اختبار السكرول...', 'info');
        }
        
        function testChart() {
            const chartTest = document.getElementById('chartTest');
            const statusDiv = document.getElementById('chartStatus');
            
            chartUpdateCount = 0;
            
            // محاكاة تحديث الرسم البياني
            chartTest.innerHTML = '<div style="color: #3498db;">📊 رسم بياني تجريبي</div>';
            
            let updateInterval = setInterval(() => {
                chartUpdateCount++;
                chartTest.innerHTML = `<div style="color: #3498db;">📊 تحديث #${chartUpdateCount}</div>`;
                
                if (chartUpdateCount > 10) {
                    clearInterval(updateInterval);
                    statusDiv.innerHTML = '<div class="status error">❌ تحديث مفرط للرسم البياني</div>';
                    log('اختبار الرسم البياني فشل: تحديث مفرط', 'error');
                }
            }, 100);
            
            setTimeout(() => {
                clearInterval(updateInterval);
                if (chartUpdateCount <= 10) {
                    statusDiv.innerHTML = '<div class="status success">✅ تحديث طبيعي للرسم البياني</div>';
                    log('اختبار الرسم البياني نجح', 'info');
                }
            }, 2000);
            
            log('بدء اختبار الرسم البياني...', 'info');
        }
        
        function showDiagnostics() {
            const diagnostics = {
                'أحداث السكرول': scrollEvents,
                'تحديثات الرسم البياني': chartUpdateCount,
                'الذاكرة المستخدمة': performance.memory ? 
                    Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) + ' MB' : 'غير متاح',
                'وقت التشغيل': Math.round(performance.now() / 1000) + ' ثانية'
            };
            
            let message = 'تشخيص النظام:\n';
            Object.entries(diagnostics).forEach(([key, value]) => {
                message += `${key}: ${value}\n`;
            });
            
            alert(message);
            log('تم عرض التشخيص', 'info');
        }
        
        function clearAllData() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات؟')) {
                localStorage.clear();
                sessionStorage.clear();
                log('تم مسح جميع البيانات', 'warning');
                alert('تم مسح البيانات. أعد تحميل الصفحة.');
            }
        }
        
        function clearLog() {
            eventLog = [];
            document.getElementById('eventLog').innerHTML = '';
            log('تم مسح السجل', 'info');
        }
        
        // دوال من النظام الأساسي (إذا كانت متاحة)
        window.stopAllIntervals = window.stopAllIntervals || function() {
            log('دالة stopAllIntervals غير متاحة', 'warning');
        };
        
        window.resetScroll = window.resetScroll || function() {
            window.scrollTo(0, 0);
            document.getElementById('scrollTest').scrollTop = 0;
            scrollEvents = 0;
            log('تم إعادة تعيين السكرول', 'info');
        };
        
        // تشغيل الفحص التلقائي
        document.addEventListener('DOMContentLoaded', () => {
            log('تم تحميل صفحة اختبار السكرول', 'info');
            setTimeout(checkSystemStatus, 1000);
        });
        
        // مراقبة الأخطاء
        window.addEventListener('error', (e) => {
            log(`خطأ: ${e.message}`, 'error');
        });
        
        // مراقبة السكرول العام
        let globalScrollCount = 0;
        window.addEventListener('scroll', () => {
            globalScrollCount++;
            if (globalScrollCount > 50) {
                log('تحذير: سكرول مفرط في الصفحة', 'warning');
                globalScrollCount = 0;
            }
        });
    </script>
</body>
</html>